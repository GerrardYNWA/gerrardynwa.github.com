title: VIO课程笔记（第4讲）
date: 2019-07-13 22:46:37
categories: Algorithm

tags: [computer vision, slam]
---
　　[深蓝学院《从零开始手写VIO》](http://www.shenlanxueyuan.com/course/160)课程笔记——第4讲：基于滑动窗口算法的VIO系统-可观性和一致性
<!-- more -->

## Section 1 - 从高斯分布到信息矩阵

### 1. SLAM问题概率建模

- 考虑某个状态$ \xi $，以及一次与该变量相关的观测$ r_i $。由于噪声的存在，观测服从概率分布$ p(r_i | \xi) $。

- 多次观测时，各个测量值相互独立，则多个测量$ r = (r_1, …, r_n)^T $构建的似然概率为它们的连乘。

- 如果知道机器人状态的先验信息$ p(\xi) $，如GPS、车轮码盘信息等，则根据Bayes法则，有后验概率：

  $$  p(\xi | r) = \frac{p(r | \xi) p(\xi)}{p(r)} $$

- 通过最大后验估计，获得系统状态的最优估计：

  $$ {\xi}_{MAP} = \mathop{\arg \max}_{\xi} p(\xi | r) $$

### 2. SLAM问题求解

- Todo

### 3. 高斯分布和协方差矩阵

- 多元高斯分布
- 当维数变大时，求解计算量巨大。如何优雅地从多元高斯分布中丢弃变量？

### 4. 样例1

- 样例对应的状态量协方差矩阵
- 对应的协方差矩阵的逆？
  - 通过计算联合高斯分布从而得到协方差矩阵的逆
  - 利用指数性质求出联合概率分布
- 对应的信息矩阵（ = 协方差的逆）
  - 信息矩阵中的零和非零的含义，零元素表示元素i和j关于其他变量条件独立
  - 协方差矩阵中非对角元素大于0表示两变量时正相关
  - 信息矩阵中非对角元素为负数，甚至为0。小于零表示在其他变量发生的条件下，元素i 和j正相关。

### 5. 样例2

- 样例对应的状态量协方差矩阵
- 对应的协方差的逆
- 对应的信息矩阵
  - 虽然x1和x3不相关，但是不说明他们的信息矩阵对应元素为零
  - 恰恰信息矩阵中A13大于0，表示的是在变量x2发生的条件下，变量x1和x3成负相关
  - 对应上面的例子即x2为常数，如果x1大，则x3小
- 如果我们移除变量，信息矩阵或协方差矩阵如何变化？
  - 变化的协方差是直接去掉变量相关的那一行和那一列
  - 变化的信息矩阵则是去掉与变量相关的项
  - 实际上需要引入边缘化和舒尔补来解决这个问题

## Section 2 - 舒尔补应用-边际概率和条件概率

### 1. 舒尔补定义

- 由来：高斯消元法会遇到舒尔补，将M矩阵变形成对角块，又能从对角块恢复成矩阵M
- 快速求解矩阵M的逆
- $$ {\begin{bmatrix}
  I & -A^{-1}B \\
  0 & I
  \end{bmatrix}} {\begin{bmatrix}
  I & A^{-1}B \\
  0 & I
  \end{bmatrix}} = I $$

### 2. 舒尔补应用与多元高斯分布

- 假设多元变量x服从高斯分布，且由两部分组成，则变量x的概率分布为：$ P(a, b) = P(a) P(b | a) $，利用舒尔补对高斯部分进行分解

- 这意味着我们能从多元高斯分布P(a|b)中分解 得到边际概率P(a)和条件概率P(b|a)

- 关于P(a)和P(b|a)的协方差

  - P(a)：边际概率的协方差就是从联合分布中取对应的矩阵块就行了
  - P(b|a)：协方差变为a对应的舒尔补，均值也变了

- 关于P(a)和P(b|a)的信息矩阵

  - 为什么要讨论P(a)和P(b|a)的信息矩阵？

    因为基于优化的SLAM问题中，我们往往直接操作的是信息矩阵，而不是协方差矩阵。所以有必要知道边际概率、条件概率的信息矩阵是何形式

  - 假设已知信息矩阵：

    $$ {\begin{bmatrix}
    A & C^T \\
    C & D
    \end{bmatrix}}^{-1} = {\begin{bmatrix}
    \Lambda_{aa} & \Lambda_{ab} \\
    \Lambda_{ba} & \Lambda_{bb}
    \end{bmatrix}} $$

  - 由公式（29）可知，协方差矩阵各块和信息矩阵之间的关系:

    $$ {\begin{bmatrix}
    A & C^T \\
    C & D
    \end{bmatrix}}^{-1} = {\begin{bmatrix}
    A^{-1} + A^{-1}C^{T}\Delta_{A}^{-1} CA^{-1} & -A^{-1}C^{T}\Delta_{A}^{-1} \\
    -\Delta_{A}^{-1} CA^{-1} & -\Delta_{A}^{-1}
    \end{bmatrix}}^{-1} = {\begin{bmatrix}
    \Lambda_{aa} & \Lambda_{ab} \\
    \Lambda_{ba} & \Lambda_{bb}
    \end{bmatrix}} $$

  - 由条件概率P(b|a)的协方差为$ \Delta_A $以及上式，易得其信息矩阵为：

    $ \Delta_{A}^{-1} = \Lambda _{bb} $

  - 由边际概率P(a)的协方差为A以及上式，易得其信息矩阵为：

    $ A^{-1} = \Lambda _{aa} - \Lambda _{ab} \Lambda _{bb}^{-1} \Lambda _{ba}   $

- 总结：

  - 边际概率对于协方差矩阵的操作是很容易的，但不好操作信息矩阵
  - 条件概率恰好相反，对于信息矩阵容易操作，但不好操作协方差矩阵

## Section 3 - 滑动窗口算法

### 1. 最小二乘的图表示

- 圆圈：表示定点，需要优化估计的变量
- 边：表示顶点之间构建的残差。有一元边、二元边、多元边...

### 2. 最小二乘问题信息矩阵的构成

- 求解的方差VS残差的方差
- 矩阵乘法公式可以写成连加

### 3. 信息矩阵的稀疏性

- 雅可比矩阵、信息矩阵的稀疏性

  由于每个残差只和某几个状态量有关，因此雅可比矩阵求导时，无关项的雅可比为0。

### 4. 信息矩阵组装过程的可视化

- 将五个残差的信息矩阵加起来，得到样例最终的信息矩阵

### 5. 基于边际概率的滑动窗口算法

- 为什么SLAM需要滑动窗口算法？

  - 随着VSLAM系统不断往新环境探索，就会有新的相机姿态以及看到新的环境特征，最小二乘残差就会越来越多，信息矩阵越来越大，计算量将不断增加。
  - 为了保持优化变量的个数在一定范围内，需要使用滑动窗口算法动态增加或移除优化变量

- 滑动窗口算法大致流程

  1. 增加新的变量进入最小二乘系统优化
  2. 如果变量数目达到了一定的维度，则移除老的变量
  3. SLAM系统不断循环前面两步

- 如何移除老的变量？

  - 利用边际概率移除老的变量

    直接丢弃变量和对应的测量值，会损失信息。正确的做法是使用边际概率，将丢弃变量所携带的信息传递给剩余变量

- 如果是直接丢弃，信息矩阵如何变化？用边际概率来操作又会带来什么问题？

  相当于直接去掉了那一行和那一列？

- marginalization会使得信息矩阵变得稠密，原先条件独立的变量，可能变得相关

## Section 4 - 滑动窗口中的FEJ算法

### 1. 新测量信息和旧测量信息构建新的系统

- 出现的问题
  1. 由于被marg的变量以及对应的测量已被丢弃，先验信息中的关于$ x_r $的雅可比在后续求解中没法更新
  2. 但$ x_r $中的部分变量还跟其他残差有联系，如$ \xi_2、\xi_5 $。这些残差对$ \xi_2 $的雅可比会随着$ \xi_2 $的迭代更新而不断在最新的线性化点处计算

### 2. 信息矩阵的零空间变化

- 滑动窗口算法导致的问题
  1. 滑动窗口算法优化的时候，信息矩阵变成两部分，且这两部分计算雅可比时的线性化点不同。这可能会导致信息矩阵的零空间发生变化，，从而在求解时引入错误信息。
  2. 多个解的问题，变成了一个确定解。不可观的变量，变成了可观的。

### 3. 可观性的一种定义

- 对于测量系统$ z = h(\theta) + \epsilon $，其中$ z \in \mathbb{R}^{n} $为测量值，$ \theta \in \mathbb{R}^{d} $为 系统状态量，$ \epsilon $为测量 噪声向量。$ h(·) $是非线性函数，将状态量映射成测量。对于理想数据，如果以下条件成立，则系统状态量$ \theta $可观：

  $$ \forall \theta, {\theta}' \in \mathbb{R}^d,  {\theta} \not= {\theta}' \Rightarrow h({\theta}) \not= h({\theta}') $$

- 对于SLAM系统而言（如单目VO），当我们改变状态量时，测量不变意味着损失函数不会改变，更意味着求解最小二乘时对应的信息矩阵存在着零空间。

- 单目SLAM系统7自由度不可观：6自由度姿态+尺度

- 单目+IMU系统是4自由度不可观：yaw角+3自由度位置不可观。roll和pitch由于重力的存在而可观，尺度因子由于加速度计的存在而可观。

### 4. 滑动窗口中的问题

- 问题：滑动窗口算法中，对于同一个变量，不同残差对其计算雅可比矩阵时线性化点可能不一致，导致其信息矩阵可以分成两部分，相当于在信息矩阵中多加了一些信息，使得其零空间发生了变化。

- 解决办法：First Estimated Jacobian

  FEJ算法：不同残差对同一个状态求雅可比时，线性化点必须一致。这样就能避免零空间退化而使得不可观变量变得可观。